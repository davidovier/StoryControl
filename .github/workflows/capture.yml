name: Story Capture

on:
  # Run daily at 13:00 Amsterdam time (12:00 UTC in winter, 11:00 UTC in summer)
  schedule:
    - cron: '0 12 * * *'  # 12:00 UTC = 13:00 Amsterdam (winter)

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

env:
  TZ: Europe/Amsterdam

jobs:
  capture:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Restore Instagram session
        env:
          IG_SESSION: ${{ secrets.IG_SESSION }}
        run: |
          mkdir -p sessions/ig
          if [ -n "$IG_SESSION" ]; then
            echo "$IG_SESSION" | base64 -d > sessions/ig/state.json
            echo "Session restored from secret"
          else
            echo "No session found - will need to login"
          fi

      - name: Run story capture
        env:
          IG_USERNAME: ${{ secrets.IG_USERNAME }}
          IG_PASSWORD: ${{ secrets.IG_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          STORAGE_BUCKET: story-captures
          HEADLESS: 'true'
          USE_SESSION_STATE: 'true'
        run: node src/runOnce.js

      - name: Save updated session
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ -f sessions/ig/state.json ]; then
            NEW_SESSION=$(base64 -w 0 sessions/ig/state.json)
            gh secret set IG_SESSION --body "$NEW_SESSION"
            echo "Session saved back to secrets"
          fi

      - name: Upload captures as artifact (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: captures-${{ github.run_number }}
          path: captures/
          retention-days: 7
          if-no-files-found: ignore
